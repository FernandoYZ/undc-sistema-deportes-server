# Sistema de Deportes UNDC - Backend

## üìã Descripci√≥n

Backend del sistema de gesti√≥n deportiva de la Universidad Nacional Daniel Carri√≥n (UNDC). Esta API REST maneja inscripciones de equipos, torneos, validaci√≥n de vouchers y administraci√≥n general del sistema deportivo universitario.

## üöÄ Tecnolog√≠as Utilizadas

- **Node.js** v22.13.1+
- **Express.js** 5.1.0 - Framework web
- **MySQL** 8.0.43 - Base de datos
- **MySQL2** 3.14.5 - Driver de base de datos con soporte para promesas
- **Socket.io** 4.8.1 - Comunicaci√≥n en tiempo real
- **JWT** - Autenticaci√≥n y autorizaci√≥n
- **bcrypt** - Encriptaci√≥n de contrase√±as
- **Multer** - Manejo de archivos (vouchers)
- **CORS** - Configuraci√≥n de dominios permitidos
- **Helmet** - Middleware de seguridad
- **Morgan** - Logger de peticiones HTTP

## üìä Base de Datos

### Estructura Principal

El sistema cuenta con las siguientes entidades principales:

#### **Tabla: `ciclos`**
Gestiona los ciclos acad√©micos (I al X).
- `id` - Identificador √∫nico
- `nombre` - Nombre del ciclo (I, II, III, etc.)

#### **Tabla: `deportes`**
Cataloga los deportes disponibles.
- `id` - Identificador √∫nico
- `nombre` - Nombre del deporte (futsal, basquet, voley, ajedrez, gincana)
- `tiempo_promedio_minutos` - Duraci√≥n promedio del deporte

#### **Tabla: `equipos`**
Registra los equipos participantes.
- `id` - Identificador √∫nico
- `nombre` - Nombre del equipo
- `ciclo_id` - Referencia al ciclo acad√©mico
- `deporte_id` - Referencia al deporte
- `email` - Correo de contacto
- `celular` - Tel√©fono de contacto
- `seccion` - Secci√≥n A o B

#### **Tabla: `jugadores`**
Informaci√≥n de los participantes.
- `id` - Identificador √∫nico
- `nombre` - Nombre completo
- `sexo` - M, F, O (Masculino, Femenino, Otro)
- `rol` - titular, suplente, capitan
- `codigo_estudiante` - C√≥digo √∫nico del estudiante
- `dni` - Documento de identidad

#### **Tabla: `eventos`**
Eventos deportivos como inscripciones y competencias.
- `id` - Identificador √∫nico
- `nombre` - Nombre del evento
- `fecha_inicio` - Fecha de inicio
- `fecha_fin` - Fecha de finalizaci√≥n

#### **Tabla: `inscripciones`**
Registro de inscripciones de equipos en eventos.
- `id` - Identificador √∫nico
- `equipo_id` - Referencia al equipo
- `evento_id` - Referencia al evento
- `cantidad_participantes` - N√∫mero de participantes
- `pagado` - Estado de pago (0/1)
- `medio_pago` - M√©todo de pago utilizado
- `tipo_pago` - regular o adicional

#### **Tabla: `vouchers`**
Validaci√≥n de comprobantes de pago.
- `id` - Identificador √∫nico
- `inscripcion_id` - Referencia a la inscripci√≥n
- `numero_voucher` - N√∫mero del comprobante
- `banco` - Entidad bancaria o m√©todo de pago
- `monto` - Cantidad pagada
- `imagen_url` - URL de la imagen del voucher
- `estado` - pendiente, validado, rechazado
- `titular` - Nombre del pagador

#### **Tabla: `enfrentamientos`**
Partidos entre equipos.
- `id` - Identificador √∫nico
- `equipo_1_id` - Primer equipo
- `equipo_2_id` - Segundo equipo
- `ganador_id` - Equipo ganador
- `partido_numero` - N√∫mero del partido

#### **Tabla: `detalle_partido`**
Informaci√≥n detallada de cada partido.
- `id` - Identificador √∫nico
- `partido_id` - Referencia al enfrentamiento
- `estado_id` - Estado del partido
- `evento_id` - Evento al que pertenece
- `fase_id` - Fase del torneo
- `fecha_inicio` - Fecha y hora de inicio
- `fecha_termino` - Fecha y hora de finalizaci√≥n
- `lugar` - Ubicaci√≥n del partido
- `puntos_equipo_1` - Puntuaci√≥n del equipo 1
- `puntos_equipo_2` - Puntuaci√≥n del equipo 2

### Relaciones Importantes

- **Equipos ‚Üî Jugadores**: Relaci√≥n muchos a muchos atrav√©s de `equipo_jugador`
- **Inscripciones ‚Üî Jugadores**: Relaci√≥n muchos a muchos atrav√©s de `inscripcion_jugador`
- **Equipos ‚Üí Ciclos**: Cada equipo pertenece a un ciclo
- **Equipos ‚Üí Deportes**: Cada equipo practica un deporte
- **Vouchers ‚Üí Inscripciones**: Cada voucher valida una inscripci√≥n

### Procedimientos Almacenados

- `mostrar_ciclos()` - Lista todos los ciclos disponibles
- `mostrar_equipos(p_evento_id, p_deporte_id)` - Muestra equipos con informaci√≥n detallada
- `verificar_codigo_estudiante(p_codigo, p_ciclo)` - Valida c√≥digos de estudiante
- `verificar_dni(p_dni, p_ciclo)` - Valida documentos de identidad

## üèóÔ∏è Arquitectura del Proyecto

```
src/
‚îú‚îÄ‚îÄ app.js                 # Configuraci√≥n principal de Express
‚îú‚îÄ‚îÄ server.js             # Punto de entrada del servidor
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.js       # Configuraci√≥n y conexi√≥n a MySQL
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ auth.middleware.js # Middleware de autenticaci√≥n
‚îî‚îÄ‚îÄ routes/
    ‚îú‚îÄ‚îÄ index.js          # Rutas principales
    ‚îú‚îÄ‚îÄ admin.routes.js   # Rutas de administraci√≥n
    ‚îú‚îÄ‚îÄ auth.router.js    # Rutas de autenticaci√≥n
    ‚îú‚îÄ‚îÄ equipos.router.js # Rutas de equipos
    ‚îú‚îÄ‚îÄ inscripciones.routes.js # Rutas de inscripciones
    ‚îú‚îÄ‚îÄ torneo.router.js  # Rutas de torneos
    ‚îî‚îÄ‚îÄ voucher.router.js # Rutas de vouchers

uploads/                  # Directorio de archivos subidos (vouchers)
```

## üîß Instalaci√≥n y Configuraci√≥n

### Prerrequisitos

- Node.js v22.13.1 o superior
- MySQL 8.0+
- npm o pnpm

### 1. Clonar el repositorio

```bash
git clone [URL_DEL_REPOSITORIO]
cd undc_deportes/server
```

### 2. Instalar dependencias

```bash
npm install
# o
pnpm install
```

### 3. Configurar variables de entorno

Crear archivo `.env` basado en `.env.example`:

```env
# Entorno de ejecuci√≥n
NODE_ENV=development
HOST=localhost
PORT=3100

# Configuraci√≥n CORS
CORS=http://localhost:3305

# Configuraci√≥n de la base de datos
DB_HOST=localhost
DB_USER=tu_usuario_mysql
DB_PASSWORD=tu_contrase√±a_mysql
DB_NAME=sistemas_undc_deportes
DB_PORT=3306

# Rutas de carga
UPLOAD_PATH=./uploads/
MAX_FILE_SIZE=5242880
```

### 4. Configurar la base de datos

1. Crear la base de datos MySQL:
```sql
CREATE DATABASE sistemas_undc_deportes;
```

2. Importar el esquema desde `sistemas_undc_deportes.sql`:
```bash
mysql -u tu_usuario -p sistemas_undc_deportes < sistemas_undc_deportes.sql
```

### 5. Crear directorio de uploads

```bash
mkdir uploads
```

### 6. Ejecutar el servidor

```bash
# Modo desarrollo
npm run dev

# Modo producci√≥n
npm start
```

## üåê API Endpoints

### Base URL
```
http://localhost:3100/api
```

### Endpoints Principales

#### **Autenticaci√≥n**
- `POST /api/admin/login` - Iniciar sesi√≥n de administrador
- `POST /api/admin/logout` - Cerrar sesi√≥n
- `GET /api/admin/verify` - Verificar token de sesi√≥n

#### **Inscripciones**
- `POST /api/inscripciones` - Crear nueva inscripci√≥n
- `GET /api/inscripciones/:id` - Obtener inscripci√≥n espec√≠fica
- `PUT /api/inscripciones/:id` - Actualizar inscripci√≥n
- `GET /api/inscripciones/evento/:eventId` - Inscripciones por evento

#### **Equipos**
- `POST /api/admin/equipos` - Crear equipo (admin)
- `GET /api/admin/equipos` - Listar equipos
- `PUT /api/admin/equipos/:id` - Actualizar equipo
- `DELETE /api/admin/equipos/:id` - Eliminar equipo

#### **Vouchers**
- `POST /api/vouchers/upload` - Subir comprobante de pago
- `GET /api/admin/vouchers` - Listar vouchers (admin)
- `PUT /api/admin/vouchers/:id/validate` - Validar voucher
- `PUT /api/admin/vouchers/:id/reject` - Rechazar voucher

#### **Torneos**
- `GET /api/admin/torneos` - Informaci√≥n de torneos
- `POST /api/admin/torneos/sorteo` - Realizar sorteo
- `GET /api/admin/torneos/partidos` - Lista de partidos
- `PUT /api/admin/torneos/partidos/:id` - Actualizar resultado

### C√≥digos de Respuesta

- `200` - √âxito
- `201` - Recurso creado exitosamente
- `400` - Solicitud incorrecta
- `401` - No autorizado
- `403` - Prohibido
- `404` - Recurso no encontrado
- `409` - Conflicto (recurso duplicado)
- `500` - Error interno del servidor

## üîí Seguridad

### Medidas Implementadas

- **Helmet**: Configuraci√≥n de headers de seguridad HTTP
- **CORS**: Control de dominios permitidos
- **JWT**: Tokens seguros para autenticaci√≥n
- **bcrypt**: Encriptaci√≥n de contrase√±as con salt
- **Validaci√≥n de archivos**: Restricciones en tipos y tama√±os de archivos
- **Sanitizaci√≥n**: Validaci√≥n y limpieza de datos de entrada
- **Rate limiting**: Control de solicitudes por IP (recomendado implementar)

### Autenticaci√≥n y Autorizaci√≥n

El sistema utiliza JWT para la autenticaci√≥n de administradores:

```javascript
// Ejemplo de middleware de autenticaci√≥n
import jwt from 'jsonwebtoken';

export const verificarToken = (req, res, next) => {
  const token = req.cookies.token;
  
  if (!token) {
    return res.status(401).json({ error: 'Token no proporcionado' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Token inv√°lido' });
  }
};
```

## üìÅ Manejo de Archivos

### Vouchers de Pago

El sistema permite la subida de comprobantes de pago (vouchers) con las siguientes caracter√≠sticas:

- **Tipos permitidos**: JPG, JPEG, PNG
- **Tama√±o m√°ximo**: 5MB (configurable en `MAX_FILE_SIZE`)
- **Directorio**: `./uploads/`
- **Nomenclatura**: `voucher-{timestamp}-{random}.{ext}`

### Configuraci√≥n Multer

```javascript
import multer from 'multer';
import path from 'path';

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, process.env.UPLOAD_PATH || './uploads/');
  },
  filename: (req, file, cb) => {
    const timestamp = Date.now();
    const randomNum = Math.floor(Math.random() * 1000000000);
    const extension = path.extname(file.originalname);
    cb(null, `voucher-${timestamp}-${randomNum}${extension}`);
  }
});
```

## üîß Configuraci√≥n de Base de Datos

### Pool de Conexiones

El sistema utiliza un pool de conexiones MySQL2 para optimizar el rendimiento:

```javascript
const configuracion = {
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  port: process.env.DB_PORT || 3306,
  waitForConnections: true,
  connectionLimit: 10,      // M√°ximo 10 conexiones simult√°neas
  queueLimit: 0,           // Sin l√≠mite en la cola
  charset: "utf8mb4",      // Soporte completo UTF-8
  connectTimeout: 60000    // Timeout de 60 segundos
};
```

### Transacciones

Para operaciones que requieren m√∫ltiples consultas, el sistema implementa transacciones:

```javascript
export const transaccion = async (consultas) => {
  const poolInstance = await conexion();
  const connection = await poolInstance.getConnection();
  
  try {
    await connection.beginTransaction();
    
    const resultados = [];
    for (const { sql, params = [] } of consultas) {
      const [result] = await connection.execute(sql, params);
      resultados.push(result);
    }
    
    await connection.commit();
    return resultados;
  } catch (error) {
    await connection.rollback();
    throw error;
  } finally {
    connection.release();
  }
};
```

## üö¶ Estados del Sistema

### Estados de Vouchers
- `pendiente` - Subido pero no validado
- `validado` - Aprobado por administrador
- `rechazado` - Rechazado por administrador

### Estados de Partidos
- `pendiente` - Programado pero no jugado
- `en curso` - Actualmente en juego
- `jugado` - Finalizado con resultado
- `cancelado` - Cancelado sin reprogramaci√≥n
- `postergado` - Aplazado para otra fecha

### Roles de Jugadores
- `capitan` - Capit√°n del equipo (contacto principal)
- `titular` - Jugador titular
- `suplente` - Jugador suplente

## üìà Monitoreo y Logs

### Logging con Morgan

El sistema implementa logging HTTP con Morgan en modo desarrollo:

```javascript
app.use(morgan('dev'));
```

### Health Check

Endpoint para verificar el estado del servidor:

```
GET /api
```

Respuesta:
```json
{
  "status": "OK",
  "timestamp": "2025-01-07T11:52:56.000Z",
  "uptime": 3600.123
}
```

## üêõ Manejo de Errores

### Middleware Global de Errores

```javascript
app.use((error, req, res, next) => {
  console.error('Error:', error);
  res.status(error.status || 500).json({
    error: process.env.NODE_ENV === 'production' 
      ? 'Something went wrong!' 
      : error.message,
    stack: process.env.NODE_ENV === 'production' ? undefined : error.stack
  });
});
```

### Manejo de Rutas No Encontradas

```javascript
app.use((req, res) => {
  res.status(404).json({ error: 'Route not found' });
});
```

## üîÑ WebSocket / Socket.io

El sistema est√° preparado para comunicaci√≥n en tiempo real usando Socket.io 4.8.1, ideal para:

- Notificaciones en tiempo real de cambios de estado de vouchers
- Actualizaciones de resultados de partidos en vivo
- Notificaciones de nuevas inscripciones
- Chat en tiempo real durante eventos

## üß™ Testing

### Estructura Recomendada

```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ database.test.js
‚îÇ   ‚îú‚îÄ‚îÄ auth.test.js
‚îÇ   ‚îî‚îÄ‚îÄ vouchers.test.js
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ inscripciones.test.js
‚îÇ   ‚îî‚îÄ‚îÄ equipos.test.js
‚îî‚îÄ‚îÄ e2e/
    ‚îî‚îÄ‚îÄ complete-flow.test.js
```

### Herramientas Sugeridas

- **Jest** - Framework de testing
- **Supertest** - Testing de API REST
- **MySQL Memory Server** - Base de datos en memoria para tests

## üöÄ Despliegue

### Variables de Producci√≥n

```env
NODE_ENV=production
HOST=0.0.0.0
PORT=3100
DB_HOST=tu_servidor_mysql
DB_USER=usuario_produccion
DB_PASSWORD=contrase√±a_segura
```

### Consideraciones de Producci√≥n

1. **Reverse Proxy**: Usar Nginx como proxy reverso
2. **HTTPS**: Configurar certificados SSL/TLS
3. **PM2**: Gestor de procesos para Node.js
4. **Backup**: Configurar respaldos autom√°ticos de la base de datos
5. **Monitoreo**: Implementar logging estructurado y m√©tricas

### Script de PM2

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'undc-deportes-api',
    script: 'src/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3100
    }
  }]
};
```
## Dockerizacion

### 1. Construir imagen
`docker build -t undc-deportes-backend .`

### 2. Ejecutar contenedor
```docker run -d   --name undc-deportes-server   -p 3100:3100   --env-file .env   -v "$(pwd)/uploads:/app/uploads"   --restart unless-stopped   undc-deportes-backend
  ```

### 3. Ver logs
`docker logs -f undc-deportes-server`

### 4. Detener
`docker stop undc-deportes-server`

### 5. Eliminar
`docker rm undc-deportes-server`

## ü§ù Contribuci√≥n

### Flujo de Trabajo

1. Fork del repositorio
2. Crear rama feature: `git checkout -b feature/nueva-funcionalidad`
3. Commit cambios: `git commit -am 'Add nueva funcionalidad'`
4. Push rama: `git push origin feature/nueva-funcionalidad`
5. Crear Pull Request

### Est√°ndares de C√≥digo

- **ESLint**: Linting de JavaScript
- **Prettier**: Formateo de c√≥digo
- **Conventional Commits**: Formato de commits
- **JSDoc**: Documentaci√≥n de funciones

